name: 'NPM package.json version check with PR Comment'
description: 'This is a composite action that checks out the pr and base branch, compares package.json versions, and comments on the PR whether there is a change or not. This can be ran more than once on the same PR.'

inputs:
  github-token:
    description: "GITHUB_TOKEN, standard one is fine"
    required: true
  node-version:
    description: "What node version to use (shouldn't really matter)"
    required: true
    default: '14.x'
    
outputs:
  version-did-change:
    description: "Whether or not the npm package.json version changed"
    value: ${{ steps.version-changed.outputs.version-did-change }}

runs:
  using: "composite"
  steps:
    - name: Checkout Base ðŸ›Žï¸
      uses: actions/checkout@v2
      with:
        persist-credentials: false
        path: "base"
        ref: ${{ github.event.pull_request.base.ref }}
    - name: Checkout PR Branch ðŸ›Žï¸
      uses: actions/checkout@v2
      with:
        persist-credentials: false
        path: "prbranch"
    - name: Node
      uses: actions/setup-node@v1
      with:
        node-version: ${{ inputs.node-version }}
    - name: Get Base NPM Version
      id: base-version
      uses: martinbeentjes/npm-get-version-action@v1.1.0
      with:
        path: base
    - run: "echo Base Version: ${{ steps.base-version.outputs.current-version }}"
      shell: bash

    - name: Get PR NPM Version
      id: pr-version
      uses: martinbeentjes/npm-get-version-action@v1.1.0
      with:
        path: prbranch
    - run: "echo PR Version: ${{ steps.pr-version.outputs.current-version }}"
      shell: bash

    - id: version-changed
      run: echo "::set-output name=version-did-change::$(echo ${{ steps.base-version.outputs.current-version != steps.pr-version.outputs.current-version }})"
      shell: bash
      
    - name: Determine Message
      uses: haya14busa/action-cond@v1
      id: message
      with:
        cond: ${{ steps.base-version.outputs.current-version != steps.pr-version.outputs.current-version }}
        if_true: "PR with version bump detected! :white_check_mark:"
        if_false: "No version bump detected. :x:"
        
    - name: PR Comment
      if: ${{ steps.base-version.outputs.current-version != steps.pr-version.outputs.current-version }}
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        message: |
          ${{ steps.message.outputs.value }}
          ${{ steps.base-version.outputs.current-version }} => ${{ steps.pr-version.outputs.current-version }}

